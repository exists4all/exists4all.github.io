<!DOCTYPE html>
<html lang="en-us">
    <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RYNLQKXDCY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-RYNLQKXDCY');
    </script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.124.0">

    
        <meta name="google-site-verification" content="FJeEV8Eq61e0o2MnOwH64y1WgBV42wPtjOS_Z8FZl4c" />
    

    

    
        
            <meta
                name="description"
                content="A place to share interesting articles,tutorials, projects in mathematics and computer science that I do and enjoy." />
        

        
            <meta
                name="keywords"
                content="Math, Mathematics, Windows, Internals, Reverse engineering" />
        

        
            <meta name="author" content="Exists4All" />
        

    


    <title>
        
            Simple Disk Serial Spoofer part 1 |
            Exists4All
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_d751713.min.c33e31e36698343dc458368c969e849132d12d4928b56dad50c0171f81fbce86a13522fabf2aef76391ff42a5b67df79b4233cfca5566cdcc4bd031889e09022.css"
            integrity="sha512-wz4x42aYND3EWDaMlp6EkTLRLUkotW2tUMAXH4H7zoahNSL6vyrvdjkf9CpbZ995tCM8/KVWbNzEvQMYieCQIg==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Simple Disk Serial Spoofer part 1 -
            Exists4All
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Posts </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://exists4all.github.io/posts/simpepecrypter/" title="./posts/simpepecrypter/">
                        SimpePECrypter
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://exists4all.github.io/posts/on_the_cryptoapi/" title="./posts/on_the_cryptoapi/">
                        On The Cryptoapi
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://exists4all.github.io/posts/simple_disk_serial_spoofer_part_1/" title="./posts/simple_disk_serial_spoofer_part_1/">
                        Simple Disk Serial Spoofer part 1
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://exists4all.github.io/posts/before_start/" title="./posts/before_start/">
                        Before Start
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Simple Disk Serial Spoofer part 1
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/exists4all/"
                                class="cat-btn">
                                Exists4All
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.03.17"
                            >2024.03.17
                        </time>
                    </div>
                

                
            </div>
        </div>

        <div class="article-meta">
            
                <div class="categories">
                    <i
                        class="bi bi-bookmarks"
                        title="Categories"></i>
                    
                        <a
                            href="/categories/windows/"
                            class="cat-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/categories/kernel/"
                            class="cat-btn">
                            Kernel
                        </a>
                    
                        <a
                            href="/categories/driver-development/"
                            class="cat-btn">
                            Driver Development
                        </a>
                    
                        <a
                            href="/categories/reverse-engineering/"
                            class="cat-btn">
                            Reverse Engineering
                        </a>
                    
                </div>
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/vmware/"
                            class="tag-btn">
                            VMware
                        </a>
                    
                        <a
                            href="/tags/windows-kernel-development/"
                            class="tag-btn">
                            Windows kernel development
                        </a>
                    
                        <a
                            href="/tags/ntoskrnl/"
                            class="tag-btn">
                            ntoskrnl
                        </a>
                    
                        <a
                            href="/tags/harddisk-serial-spoofing/"
                            class="tag-btn">
                            Harddisk serial spoofing
                        </a>
                    
                        <a
                            href="/tags/kernel-spoofer/"
                            class="tag-btn">
                            Kernel spoofer
                        </a>
                    
                        <a
                            href="/tags/windows-internals/"
                            class="tag-btn">
                            Windows Internals
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="https://exists4all.github.io/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://exists4all.github.io/posts/" class="bread-btn">
    

    
        Posts
    
</a>




    /



<a href="https://exists4all.github.io/posts/simple_disk_serial_spoofer_part_1/" class="bread-btn">
    

    
        Simple Disk Serial Spoofer part 1
    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents"></nav>
        


        <div class="content">
            
                <p>In this tutorial we are going to create a static disk drive serial number spoofer. This project will be a little long and need some basic knowledge about operation systems and reverse engineering. We are going to use visual studio community, IDA and windbg and I used windows 11 enterprise.</p>
<hr>
<p>The first step is to find out how windows get that information. By googling you can see easily you have to use wmic commands. If you open CMD and execute the <strong>wmic diskdrive get serialnumber</strong>, you can retrieve all the disk serials.
So that is logical analyzing wmic in windbg, however if you do that you will find out wmic tokenize commands and send them to the kernel and then retrieve data in a xml file and fetch from there. So for simplicity we are not going to analyze wmic. Instead we are going to access wmic command directly using C++ and use debug command to see which kernel API used to get those data.</p>
<p>But for the people who are interested in analyzing wmic i will point to a little hint to do it.First of all run your virtual OS and attach kernel debugger aka windbg to it. Break windbg and use <strong>!sym noisy</strong> command and then execute <strong>lm</strong> and finally <strong>.reload</strong> to reload all needed pdbs. Also keep it in mind to add debug filter print to your OS so you can see dbgprint data in debugger, just google it.After windbg downloaded all the necessary data open execute <strong>g</strong> command and run wmic on VM. After that execute <strong>.reload /f wmic.exe</strong> this will cause windbg download wmic pdb file so you can copy it from windbg path for pdbs and use it with ida to analyzing wmic.exe. After this we want to get in to the wmic.exe context to do that execute <strong>!process 0 0 wmic.exe</strong> keep note from you process ID and then execute <strong>.process /i YOURPROCESSID</strong> execute <strong>g</strong> command to get to the context.</p>
<p>Now execute the <strong>lm</strong> command and search for WMIC in the modules list, click on it and then you can see all the functions WMIC uses. Now for exampl you can put a break point on <strong>WMIC!CExecEngine::ExecuteCommand</strong> using <strong>bp WMIC!CExecEngine::ExecuteCommand</strong> and then execute <strong>g</strong>, now use a command like <strong>diskdrive</strong> to hit break point on windbg.
You can use this method alongside wmic.exe and its pdb in IDA to analyze.</p>
<p>As I mentioned before wmic will make it harder to understand how windows get disk serials, instead we are going to get those data directly ourselves by calling wmic directly with our C++ program. I used this code <a href="https://gist.github.com/micjabbour/a2fbe50160862e6abe439c0b0769c3fb">this code</a>, just compile it with a static linked library and copy it alongside its pdb file to your vm. Now we want to be able to use windbg to get kernel apis, but how do we put breakpoints on it?! There are two methods one is to breakpoint onload, and the other is simply adding  <strong>__debugbreak();</strong> before the place we want to hit. I added this command immediately after main. The other method is useful when we do not have access to source code.For those who want to know how to do it the other way, just follow the instructions below.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="1.%20!gflag%20&#43;ksl%0a2.%20sxe%20ld%20myfile.exe%0a3.%20g%0a4.%20execute%20your%20file,%20you%20will%20hit%20break%20point%20onload%0a5.%20!gflag%20-ksl%20%28do%20not%20need%20flag%20after%20hit%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>1. !gflag &#43;ksl
2. sxe ld myfile.exe
3. g
4. execute your file, you will hit break point onload
5. !gflag -ksl (do not need flag after hit)</code></pre>
    
</div>
<p>But in our case we have access to source code so just add debug instruction after main and then copy .pdb and your exe to your vm, also set your source code path in windbg. After that simply execute your file on your VM, this will cause windbg to hit breakpoint, then use the <strong>.reload</strong> command to reload out program pdb. I compiled my file with <strong>UserFetch</strong> name, if you did every thing right you should see something like below:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>Loading User Symbols
.....
Loading unloaded module list
.......
SYMSRV:  BYINDEX: 0x2D
C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym
UserFetch.pdb
2E5ED8B3A33C4594893DBF2981D63F982
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pdb - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pd_ - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\file.ptr - path not found
SYMSRV:  RESULT: 0x80070003
SYMSRV:  BYINDEX: 0x2E
C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym*https://msdl.microsoft.com/download/symbols
UserFetch.pdb
2E5ED8B3A33C4594893DBF2981D63F982
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pdb - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pd_ - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\file.ptr - path not found
SYMSRV:  HTTPGET: /download/symbols/UserFetch.pdb/2E5ED8B3A33C4594893DBF2981D63F982/UserFetch.pdb
SYMSRV:  HttpQueryInfo: 80190194 - HTTP_STATUS_NOT_FOUND
SYMSRV:  HTTPGET: /download/symbols/UserFetch.pdb/2E5ED8B3A33C4594893DBF2981D63F982/UserFetch.pd_
SYMSRV:  HttpQueryInfo: 80190194 - HTTP_STATUS_NOT_FOUND
SYMSRV:  HTTPGET: /download/symbols/UserFetch.pdb/2E5ED8B3A33C4594893DBF2981D63F982/file.ptr
SYMSRV:  HttpQueryInfo: 80190194 - HTTP_STATUS_NOT_FOUND
SYMSRV:  RESULT: 0x80190194
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pdb - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pdb - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pd_ - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pd_ - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\file.ptr - path not found
SYMSRV:  UNC: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\file.ptr - path not found
DBGHELP: I:\Codes\UserFetch\x64\Debug\UserFetch.pdb cached to C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\sym\UserFetch.pdb\2E5ED8B3A33C4594893DBF2981D63F982\UserFetch.pdb</code></pre>
    
</div>
<p>Also you have to be able to see your source code alongside other information like below.</p>
<p><img src="/Simple_Disk_Serial_Spoofer_part_1/LoadSelfPDB.jpg" alt="Image_1"></p>
<p>Now this part is very very important, we want to be able to go to the kernel side and continue tracing kernel APIs there. To do this we need to find <strong>syscall</strong> instructions first.To do this just execute <strong>pc</strong> and then <strong>t</strong> command respectively till you reach a syscall.
After that we need to find a function that will cause dispatch from user mode to kernel mode using the <strong>SSD table</strong> which I will explain later. execute <strong>p</strong> command till you reach first <strong>if</strong> then using <strong>t</strong> to trace in to it and then use mentioned instructions.</p>
<p>After a while you will hit <strong>DeviceIoControl</strong> which is look like below:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">ntdll</span>!<span style="color:#66d9ef">NtDeviceIoControlFile</span>:
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23fe0</span> <span style="color:#ae81ff">4</span><span style="color:#66d9ef">c8bd1</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">r10</span>,<span style="color:#66d9ef">rcx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23fe3</span> <span style="color:#66d9ef">b807000000</span>      <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23fe8</span> <span style="color:#66d9ef">f604250803fe7f01</span> <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">SharedUserData</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x308</span> (<span style="color:#ae81ff">000000007</span><span style="color:#66d9ef">ffe0308</span>)],<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23ff0</span> <span style="color:#ae81ff">7503</span>            <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntdll</span>!<span style="color:#66d9ef">NtDeviceIoControlFile</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x15</span> (<span style="color:#ae81ff">00007</span><span style="color:#66d9ef">ff927a23ff5</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23ff2</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f05</span>            <span style="color:#66d9ef">syscall</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23ff4</span> <span style="color:#66d9ef">c3</span>              <span style="color:#66d9ef">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23ff5</span> <span style="color:#66d9ef">cd2e</span>            <span style="color:#66d9ef">int</span>     <span style="color:#ae81ff">2</span><span style="color:#66d9ef">Eh</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23ff7</span> <span style="color:#66d9ef">c3</span>              <span style="color:#66d9ef">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">ff927a23ff8</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f1f840000000000</span> <span style="color:#66d9ef">nop</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">rax</span>]</span></span></code></pre></div>
    
</div>
<p>Now we have to find out which function will called in kernel side. To do this first we look into the value that will put in to the eax register which ix <strong>0x7</strong>, now we execute following command, <strong>dd nt!KiServiceTable+0xEAXValue*0x4 L1</strong> which in our case is <strong>dd nt!KiServiceTable+0x7*0x4 L1</strong> and that will cause windbg return first value of table.
after that windbg will return <strong>fffff801`6d0cad8c  05c38306</strong> now the second value is the value we want and we have to use in the following instruction
<strong>u KiServiceTable + (0xReturnedValue &raquo;&gt; 4)</strong> so we have to execute <strong>u KiServiceTable + (0x05c38306 &raquo;&gt; 4)</strong>, after that you see instructions like below:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">nt</span>!<span style="color:#66d9ef">NtDeviceIoControlFile</span>:
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5a0</span> <span style="color:#ae81ff">4883</span><span style="color:#66d9ef">ec68</span>        <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">rsp</span>,<span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5a4</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b8424b8000000</span>  <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">B8h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5ab</span> <span style="color:#66d9ef">c644245001</span>      <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">50</span><span style="color:#66d9ef">h</span>],<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5b0</span> <span style="color:#ae81ff">89442448</span>        <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">48</span><span style="color:#66d9ef">h</span>],<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5b4</span> <span style="color:#ae81ff">488</span><span style="color:#66d9ef">b8424b0000000</span> <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">B0h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5bc</span> <span style="color:#ae81ff">4889442440</span>      <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">40</span><span style="color:#66d9ef">h</span>],<span style="color:#66d9ef">rax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5c1</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b8424a8000000</span>  <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">A8h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016d68e5c8</span> <span style="color:#ae81ff">89442438</span>        <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">38</span><span style="color:#66d9ef">h</span>],<span style="color:#66d9ef">eax</span></span></span></code></pre></div>
    
</div>
<p>If you want to learn more about <strong>SSDT</strong> you can read <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/glimpse-into-ssdt-in-windows-x64-kernel">this</a>.</p>
<p>Now put a break point in there using <strong>bp nt!NtDeviceIoControlFile</strong>, and use <strong>g</strong> to hit that break point.
After breakpoint hit you must confirm that you are still in our process context using <strong>!process -1 0</strong> command and it have to be your exe file.Now after this part is a little bit tricky you might get BSOD multiple times, but you have to open the call stack tab and use <strong>t</strong> and <strong>pc</strong> command till you find out all the kernel APIs called to get disk serial.
After a long trace you have to see something like below which contains all the kernel APIs used to get serialnumber.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="storport!RaGetUnitStorageDeviceProperty%0astorport!RaUnitStorageQueryDevicePropertyIoct1&#43;0x36%0astorport!RaUnitStorageQueryPropertyIoct1&#43;0x42%0astorport!RaUnitDeviceControlIrp&#43;Ox106%0astorport!RaDriverDeviceControlIrp&#43;Ox5a%0astorport!SrbShimHookDeviceControl&#43;0x52%0ant!IofCallDriver&#43;0x59%0aCLASSPNP!ClassDeviceControl&#43;0xa47%0adisk!DiskDeviceControl&#43;Oxa6%0aCLASSPNP!ClassDeviceControlDispatch&#43;0x82%0aCLASSPNP!ClassGlobalDispatch&#43;0x24%0ant!IofCallDriver&#43;0x59%0apartmgr!PmIoctlQueryProperty&#43;Ox57%0apartmgr!PmFilterDeviceControl&#43;Oxeb%0apartmgr!PmGlobalDispatch&#43;0x20%0ant!IofCallDriver&#43;0x59%0ant!IopSynchronousServiceTail&#43;Ox1a5%0ant!IopXxxControlFile&#43;Oxcl0%0ant!NtDeviceIoControlFile&#43;Ox56%0ant!RiSystemServiceCopyEnd&#43;0x25%0antdll!NtDeviceIoControlFile&#43;0x14%0aKERNELBASE!DeviceIoControl&#43;0x67%0aKERNEL32!DeviceIoControlImplementation&#43;0x80">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>storport!RaGetUnitStorageDeviceProperty
storport!RaUnitStorageQueryDevicePropertyIoct1&#43;0x36
storport!RaUnitStorageQueryPropertyIoct1&#43;0x42
storport!RaUnitDeviceControlIrp&#43;Ox106
storport!RaDriverDeviceControlIrp&#43;Ox5a
storport!SrbShimHookDeviceControl&#43;0x52
nt!IofCallDriver&#43;0x59
CLASSPNP!ClassDeviceControl&#43;0xa47
disk!DiskDeviceControl&#43;Oxa6
CLASSPNP!ClassDeviceControlDispatch&#43;0x82
CLASSPNP!ClassGlobalDispatch&#43;0x24
nt!IofCallDriver&#43;0x59
partmgr!PmIoctlQueryProperty&#43;Ox57
partmgr!PmFilterDeviceControl&#43;Oxeb
partmgr!PmGlobalDispatch&#43;0x20
nt!IofCallDriver&#43;0x59
nt!IopSynchronousServiceTail&#43;Ox1a5
nt!IopXxxControlFile&#43;Oxcl0
nt!NtDeviceIoControlFile&#43;Ox56
nt!RiSystemServiceCopyEnd&#43;0x25
ntdll!NtDeviceIoControlFile&#43;0x14
KERNELBASE!DeviceIoControl&#43;0x67
KERNEL32!DeviceIoControlImplementation&#43;0x80</code></pre>
    
</div>
<p><img src="/Simple_Disk_Serial_Spoofer_part_1/CallStackKernelAPIs.jpg" alt="Image_2"></p>
<p>Now you know that <strong>storport.sys</strong> is the driver that gets that data, so first we get its pdb file to be able to analyze it with IDA.Simply use <strong>lm</strong> to list all modules and then find <strong>storport</strong> click on it and then click on browse all global symbols, that will cause windbg download the pdb file.
Now copy that pdb file and paste it into your VM. and on your VM go to Local Disk <strong>(C:)\Windows\System32\drivers</strong> and copy <strong>storport.sys</strong> beside its pdb and load it into IDA.</p>
<p>Search for <strong>RaGetUnitStorageDeviceProperty</strong> and decompile it using <strong>F5</strong> key.You can see that it uses some kind of struct and puts data into an array finally and returns it if you analyze the decompiled source. To confirm this we just need a simple debug to confirm this function gets serial disks. So once more run the compiled exe file and put a breakpoint on <strong>RaGetUnitStorageDeviceProperty</strong> using <strong>bp storport!RaGetUnitStorageDeviceProperty</strong> command.
Simply keep continuing till you hit the desired break point, now if you analyze the codes of this driver in IDA, you can see the final <strong>call</strong> instruction at the bottom. Using the <strong>pc</strong> command we debug the instruction to get to that call which you can see it below.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="fffff8016edd573c%20e8bfa9f9ff%20%20%20%20%20%20call%20%20%20%20storport!memcpy%20%28fffff8016ed70100%29%0afffff8016edd5741%20458bc6%20%20%20%20%20%20%20%20%20%20mov%20%20%20%20%20r8d,r14d%0afffff8016edd5744%20488d542420%20%20%20%20%20%20lea%20%20%20%20%20rdx,[rsp&#43;20h]%0afffff8016edd5749%20498bcc%20%20%20%20%20%20%20%20%20%20mov%20%20%20%20%20rcx,r12%0afffff8016edd574c%20e8afa9f9ff%20%20%20%20%20%20call%20%20%20%20storport!memcpy%20%28fffff8016ed70100%29%0afffff8016edd5751%2033c0%20%20%20%20%20%20%20%20%20%20%20%20xor%20%20%20%20%20eax,eax%0afffff8016edd5753%20458937%20%20%20%20%20%20%20%20%20%20mov%20%20%20%20%20dword%20ptr%20[r15],r14d%0afffff8016edd5756%20488b8db0000000%20%20mov%20%20%20%20%20rcx,qword%20ptr%20[rbp&#43;0B0h]%0afffff8016edd575d%204833cc%20%20%20%20%20%20%20%20%20%20xor%20%20%20%20%20rcx,rsp%0afffff8016edd5760%20e83b9bf9ff%20%20%20%20%20%20call%20%20%20%20storport!_security_check_cookie%20%28fffff8016ed6f2a0%29%0afffff8016edd5765%204881c4c0010000%20%20add%20%20%20%20%20rsp,1C0h">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd573c</span> <span style="color:#66d9ef">e8bfa9f9ff</span>      <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">storport</span>!<span style="color:#66d9ef">memcpy</span> (<span style="color:#66d9ef">fffff8016ed70100</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5741</span> <span style="color:#ae81ff">458</span><span style="color:#66d9ef">bc6</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">r8d</span>,<span style="color:#66d9ef">r14d</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5744</span> <span style="color:#ae81ff">488</span><span style="color:#66d9ef">d542420</span>      <span style="color:#66d9ef">lea</span>     <span style="color:#66d9ef">rdx</span>,[<span style="color:#66d9ef">rsp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">20</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5749</span> <span style="color:#ae81ff">498</span><span style="color:#66d9ef">bcc</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">rcx</span>,<span style="color:#66d9ef">r12</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd574c</span> <span style="color:#66d9ef">e8afa9f9ff</span>      <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">storport</span>!<span style="color:#66d9ef">memcpy</span> (<span style="color:#66d9ef">fffff8016ed70100</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5751</span> <span style="color:#ae81ff">33</span><span style="color:#66d9ef">c0</span>            <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5753</span> <span style="color:#ae81ff">458937</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">r15</span>],<span style="color:#66d9ef">r14d</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5756</span> <span style="color:#ae81ff">488</span><span style="color:#66d9ef">b8db0000000</span>  <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">rcx</span>,<span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rbp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">B0h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd575d</span> <span style="color:#ae81ff">4833</span><span style="color:#66d9ef">cc</span>          <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">rcx</span>,<span style="color:#66d9ef">rsp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5760</span> <span style="color:#66d9ef">e83b9bf9ff</span>      <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">storport</span>!<span style="color:#66d9ef">_security_check_cookie</span> (<span style="color:#66d9ef">fffff8016ed6f2a0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fffff8016edd5765</span> <span style="color:#ae81ff">4881</span><span style="color:#66d9ef">c4c0010000</span>  <span style="color:#66d9ef">add</span>     <span style="color:#66d9ef">rsp</span>,<span style="color:#ae81ff">1</span><span style="color:#66d9ef">C0h</span></span></span></code></pre></div>
    
</div>
<p>By some analyzing you can find out code will keep data in <strong>[rsp+20h]</strong>, simply if we chek this place on memory you see the below information there:</p>
<p><img src="/Simple_Disk_Serial_Spoofer_part_1/SerialsInMeomory.jpg" alt="Image_3"></p>
<p>So we confirmed this is the function, however the used struct is still unknown. We will discuss how to find it in the next part, but we mention one of the time consuming methods here and keep the neat method for the next part.You can use <strong>dt module!</strong>* which will be <strong>dt storport!</strong>* to get all the structs that <strong>strport.sys</strong> uses and then analyze them manually.
If you spend a lot of time doing reverse engineering you can confirm the struct is <strong>_RAID_UNIT_EXTENSION</strong> which will be discussed in next part.</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>Exists4All</li>
            

            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        1667
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.124.0</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Mar 17 2024 07:37:04
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
